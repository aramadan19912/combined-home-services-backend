name: Azure Provision

on:
  workflow_dispatch:
    inputs:
      location:
        description: 'Azure region (e.g., eastus, westus2)'
        required: false
        default: 'eastus'
      resource_group:
        description: 'Resource group name'
        required: false
        default: 'hsapp-rg'

permissions:
  id-token: write
  contents: read

jobs:
  provision:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Run Provision Script
        id: provision
        env:
          LOCATION: ${{ github.event.inputs.location || 'eastus' }}
          RESOURCE_GROUP: ${{ github.event.inputs.resource_group || 'hsapp-rg' }}
        run: |
          chmod +x ./infra/azure/provision.sh
          ./infra/azure/provision.sh
      
      - name: Show Outputs
        run: |
          echo "‚úÖ Provisioning complete!"
          echo ""
          echo "üìù Please save these values as GitHub secrets:"
          echo "RESOURCE_GROUP=${{ steps.provision.outputs.RESOURCE_GROUP }}"
          echo "ACR_NAME=${{ steps.provision.outputs.ACR_NAME }}"
          echo "ACR_LOGIN_SERVER=${{ steps.provision.outputs.ACR_LOGIN_SERVER }}"
          echo "WEBAPP_API=${{ steps.provision.outputs.WEBAPP_API }}"
          echo "WEBAPP_AUTH=${{ steps.provision.outputs.WEBAPP_AUTH }}"
          echo "WEBAPP_FRONTEND=${{ steps.provision.outputs.WEBAPP_FRONTEND }}"